# 4일차 – 트랜잭션 & 동시성 전략 결정 (어떻게 하면 좋을지 생각만 하기)
## 목표 : 면접 질문이 나올 지점 선제 정리
## 체크리스트
주문 생성 트랜잭션 범위 결정  
결제 요청을 트랜잭션에 포함할지 여부 결정  
재고 동시성 해결 방식 후보 정리 (낙관적 락, 비관적 락)  
산출물 : 선택한 방식과 이유 기록

## 체크리스트 정리
- 주문 생성 트랜잭션 범위  
  예제에서는 주문 생성은 엔티티 조회, 배송 정보 생성, 주문 상품 생성, 주문 생성, 주문 완료 순서였다.  
  지금은 장바구니 기능을 추가하지 않은 주문과 결제의 일대일 매핑 설계이므로, 결제 요청까지도 한 트랜잭션에 넣어도 되지만, 나중에 장바구니 기능을 추가하면 결제와 주문을 분리해야 하고, 결제 요청은 결제를 시도할 때, 나와야 한다.  
  그래서 주문 생성 트랜잭션은 주문 생성까지 넣는다.


- 결제 요청을 트랜잭션에 포함할지 여부  
  결제는 외부 API를 호출해서 트랜잭션을 길게 유지해서 오랜 시간 동안 DB 락을 잡고 있을 수 있다.  
  그래서 결제 요청과 결제는 트랜잭션에 포함하지 않고, 비동기 + 재시도 패턴을 사용하고, 결제 결과를 별도의 트랜잭션으로 저장한다.


- 재고 동시성 해결 방식 후보 정리  
  동시성은 동시에 여러 작업을 처리하는 능력이다. (동시에 여러 스레드, 여러 트랜잭션이 접근할 수 있다.)  
  멀티 스레드 환경에서는 동시에 여러 스레드가 접근하면서 문제를 일으킬 수가 있다.  
  본 프로젝트의 경우, 동시에 두 손님이 주문할 때, 재고 수량이 제대로 줄지 않거나, 재고 수량을 초과해서 주문이 적용될 문제가 생길 수 있다.  
  위의 동시성 문제를 해결하기 위한 전략으로 비관적 락을 사용해야 한다.  
  낙관적 락이 비관적 락에 비해 성능은 좋을 수 있으나, 재고 관리 같은 데이터 변형이 자주 일어나는 시스템이므로 데이터 정확성이 더 중요하다.  
  따라서, 비관적 락을 사용해서 데이터의 일관성을 지켜야 한다. 하지만 너무 많이 사용하면 성능이 줄어들 수 있어서 데이터 변경이 자주 겹치는 부분에만 사용해야 한다.

## 면접 예상 질문
- 재고 차감 로직을 서비스 계층이 아니라 주문 상품 엔티티가 책임지도록 한 이유는? (AI 질문)  
  엔티티에서 비즈니스 로직을 책임지고, 서비스 계층에서 엔티티에 필요한 요청을 위임하는 역할은 도메인 모델 패턴이다.  
  도메인 모델 패턴은 객체 지향적이어서 재사용, 유지보수, 복잡한 시스템에서 사용하기 좋다.

- 주문 상태와 결제 상태를 분리해서 관리한 이유는? (AI 질문)  
  주문 상태와 결제 상태를 분리하면 결제 실패 시, 주문 상태는 주문 생성 상태를 유지하고, 결제 상태만 결제 실패가 돼서 진행 중인 주문 상태가 변하지 않는다.  
  주문 상태에 결제 여부 포함하는 건 괜찮지만, 결제 실패는 결제 로직과 관련돼서 결제 상태로 분리해서 넣었다.

- 낙관적 락과 비관적 락의 차이는?  
  낙관적 락은 충돌이 발생했을 때, 예외를 처리해서 읽기 비중이 높고 수정이 적은 경우에 적합하다.  
  비관적 락은 미리 충돌을 대비해서 하나의 스레드가 접근하면 락을 걸어서 데이터 변경이 자주 일어나는 곳에 적합하다.

### 참고 자료
- [외부 API 트랜잭션](https://www.inflearn.com/community/questions/1686639/%EC%99%B8%EB%B6%80-api-%ED%98%B8%EC%B6%9C%EC%9D%B4-%EC%8B%A4%ED%8C%A8%ED%95%9C-%EA%B2%BD%EC%9A%B0-%EB%82%B4-%EC%84%9C%EB%B9%84%EC%8A%A4-db-%EB%8D%B0%EC%9D%B4%ED%84%B0%EC%9D%98-%EC%A0%95%ED%95%A9%EC%84%B1%EC%9D%80-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%90%98%EB%82%98%EC%9A%94?srsltid=AfmBOoqoyCcpJt_0Y4OSSQYU_rWPtkPXx6UoIbbPNoAqBVe5mYLc-gdI)
- [동시성 전략](https://velog.io/@c0smosaur/%EB%8F%99%EC%8B%9C%EC%84%B1)